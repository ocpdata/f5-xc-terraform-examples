name: "F5 XC Bot Defense on RE Destroy"

on:
  workflow_dispatch:

jobs:
  terraform_xc:
    name: "Destroy F5 XC Infra"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./xc
    env:
      # ── XC Provider ──────────────────────────────────────────────────────────
      TF_VAR_api_url: ${{ secrets.XC_API_URL }}
      TF_VAR_xc_tenant: ${{ secrets.XC_TENANT }}
      TF_VAR_xc_namespace: ${{ vars.XC_NAMESPACE }}
      TF_VAR_app_domain: ${{ vars.APP_DOMAIN }}
      TF_VAR_tf_cloud_organization: ${{ secrets.TF_CLOUD_ORGANIZATION }}
      TF_VAR_ssh_key: ${{ secrets.SSH_PRIVATE_KEY }}
      # ── Bot Defense (fixed values for this workflow) ─────────────────────────
      TF_VAR_xc_bot_def: "true"
      TF_VAR_vk8s: "true" # Terraform coerces string "true" to bool
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Setup Terraform Backend
        id: backend
        run: |
          cat > backend.tf << 'TFEOF'
          terraform {
            cloud {
              organization = "${{ secrets.TF_CLOUD_ORGANIZATION }}"
              workspaces {
                name = "${{ vars.TF_CLOUD_WORKSPACE_XC }}"
              }
            }
          }
          TFEOF
          echo "${{ secrets.XC_API_P12_FILE }}" | base64 -d > api.p12
          echo "VES_P12_FILE=$(pwd)/api.p12" >> "$GITHUB_ENV"

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Destroy
        run: terraform destroy -auto-approve -input=false
