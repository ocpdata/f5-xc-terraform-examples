name: "F5XC WAF on CE Destroy"
# Destroys resources in reverse order: F5XC WAF → AKS Cluster → Azure Infra.
# Execution is manual (workflow_dispatch). Same secrets/variables as apply workflow.
#
# Required GitHub Secrets:
#   TF_API_TOKEN                      - Terraform Cloud API token
#   TF_CLOUD_ORGANIZATION             - Terraform Cloud organization name
#   AZURE_SUBSCRIPTION_ID             - Azure Subscription ID
#   AZURE_TENANT_ID                   - Azure Tenant ID
#   AZURE_CLIENT_ID                   - Azure Service Principal App ID
#   AZURE_CLIENT_SECRET               - Azure Service Principal Password
#   SSH_PRIVATE_KEY                   - SSH private key (public key is derived at runtime)
#   XC_TENANT                         - F5 XC tenant name
#   XC_API_URL                        - F5 XC API URL
#   XC_P12_PASSWORD                   - Password for the F5 XC .p12 certificate
#   XC_API_P12_FILE                   - F5 XC API certificate (.p12) in base64
#
# Required GitHub Variables (Settings -> Secrets and variables -> Variables):
#   TF_CLOUD_WORKSPACE_AZURE_INFRA    - TFC workspace name for Azure Infra
#   TF_CLOUD_WORKSPACE_AKS_CLUSTER    - TFC workspace name for AKS Cluster
#   TF_CLOUD_WORKSPACE_XC_DEPLOY      - TFC workspace name for F5 XC
#   AZURE_REGION                      - Azure region (e.g. eastus)
#   PROJECT_PREFIX                    - Prefix for all resource names
#   XC_NAMESPACE                      - F5 XC namespace
#   APP_DOMAIN                        - App FQDN

on:
  workflow_dispatch:

jobs:
  terraform_xc_lb:
    name: "F5XC WAF"
    runs-on: ubuntu-latest
    env:
      TF_VAR_tf_cloud_organization: ${{ secrets.TF_CLOUD_ORGANIZATION }}
      TF_VAR_azure: ${{ vars.TF_CLOUD_WORKSPACE_AZURE_INFRA }}
      TF_VAR_aks_workspace: ${{ vars.TF_CLOUD_WORKSPACE_AKS_CLUSTER }}
      TF_VAR_xc_tenant: ${{ secrets.XC_TENANT }}
      TF_VAR_api_url: ${{ secrets.XC_API_URL }}
      TF_VAR_xc_namespace: ${{ vars.XC_NAMESPACE }}
      TF_VAR_app_domain: ${{ vars.APP_DOMAIN }}
      VOLT_API_P12_FILE: ${{ github.workspace }}/xc/api.p12
      VES_P12_PASSWORD: ${{ secrets.XC_P12_PASSWORD }}
    defaults:
      run:
        working-directory: ./xc
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Setup Terraform Backend and Certificate
        id: backend
        run: |
          cat > backend.tf <<-EOF
          terraform {
            cloud {
              organization = "${{ secrets.TF_CLOUD_ORGANIZATION }}"
              workspaces {
                name = "${{ vars.TF_CLOUD_WORKSPACE_XC_DEPLOY }}"
              }
            }
          }
          EOF
          echo "${{ secrets.XC_API_P12_FILE }}" | base64 -d > api.p12

      - name: Derive SSH public key from private key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/ssh_private_key
          chmod 600 /tmp/ssh_private_key
          SSH_PUB=$(ssh-keygen -y -f /tmp/ssh_private_key)
          rm -f /tmp/ssh_private_key
          echo "TF_VAR_ssh_key=${SSH_PUB}" >> $GITHUB_ENV

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan Destroy
        id: plan
        run: terraform plan -destroy -no-color -input=false
        continue-on-error: true

      - name: Terraform Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1

      - name: Terraform Destroy
        run: terraform destroy -auto-approve -input=false

      - name: Delete XC Namespace
        run: |
          XC_API_BASE=$(echo "${{ secrets.XC_API_URL }}" | sed 's|/api$||')
          # Extract cert and key from P12 for curl (use -legacy for OpenSSL 3.x compatibility)
          openssl pkcs12 -legacy -in api.p12 -passin pass:"${{ secrets.XC_P12_PASSWORD }}" -nokeys -clcerts -out /tmp/client.crt
          openssl pkcs12 -legacy -in api.p12 -passin pass:"${{ secrets.XC_P12_PASSWORD }}" -nocerts -nodes -out /tmp/client.key
          if [ ! -s /tmp/client.crt ] || [ ! -s /tmp/client.key ]; then
            echo "ERROR: Failed to extract cert/key from P12"
            exit 1
          fi
          HTTP_CODE=$(curl -s -o /tmp/ns_del_response.json -w "%{http_code}" \
            --cert /tmp/client.crt \
            --key /tmp/client.key \
            -X DELETE \
            "${XC_API_BASE}/api/web/namespaces/${{ vars.XC_NAMESPACE }}")
          rm -f /tmp/client.crt /tmp/client.key
          echo "Response code: ${HTTP_CODE}"
          cat /tmp/ns_del_response.json
          # 200=deleted, 404=already gone — both are acceptable
          if [ "${HTTP_CODE}" != "200" ] && [ "${HTTP_CODE}" != "404" ]; then
            echo "ERROR: Failed to delete namespace (HTTP ${HTTP_CODE})"
            exit 1
          fi

  terraform_aks:
    name: "Azure AKS"
    runs-on: ubuntu-latest
    needs: terraform_xc_lb
    env:
      TF_VAR_tf_cloud_organization: ${{ secrets.TF_CLOUD_ORGANIZATION }}
      TF_VAR_azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      TF_VAR_azure_subscription_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
      TF_VAR_azure_service_principal_appid: ${{ secrets.AZURE_CLIENT_ID }}
      TF_VAR_azure_service_principal_password: ${{ secrets.AZURE_CLIENT_SECRET }}
      TF_VAR_azure_infra_workspace: ${{ vars.TF_CLOUD_WORKSPACE_AZURE_INFRA }}
      TF_VAR_use_new_vnet: "true"
    defaults:
      run:
        working-directory: ./azure/aks-cluster
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Setup Terraform Backend
        id: backend
        run: |
          cat > backend.tf <<-EOF
          terraform {
            cloud {
              organization = "${{ secrets.TF_CLOUD_ORGANIZATION }}"
              workspaces {
                name = "${{ vars.TF_CLOUD_WORKSPACE_AKS_CLUSTER }}"
              }
            }
          }
          EOF

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan Destroy
        id: plan
        run: terraform plan -destroy -no-color -input=false
        continue-on-error: true

      - name: Terraform Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1

      - name: Terraform Destroy
        run: terraform destroy -auto-approve -input=false

  terraform_infra:
    name: "Azure Infra"
    runs-on: ubuntu-latest
    needs: terraform_aks
    env:
      TF_VAR_azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      TF_VAR_azure_subscription_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
      TF_VAR_azure_service_principal_appid: ${{ secrets.AZURE_CLIENT_ID }}
      TF_VAR_azure_service_principal_password: ${{ secrets.AZURE_CLIENT_SECRET }}
      TF_VAR_azure_region: ${{ vars.AZURE_REGION }}
      TF_VAR_project_prefix: ${{ vars.PROJECT_PREFIX }}
    defaults:
      run:
        working-directory: ./azure/azure-infra
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Setup Terraform Backend and Variables
        id: backend
        run: |
          cat > backend.tf <<-EOF
          terraform {
            cloud {
              organization = "${{ secrets.TF_CLOUD_ORGANIZATION }}"
              workspaces {
                name = "${{ vars.TF_CLOUD_WORKSPACE_AZURE_INFRA }}"
              }
            }
          }
          EOF
          cat > github.auto.tfvars <<-EOF
          nap         = false
          nic         = false
          bigip       = false
          bigip-cis   = false
          aks-cluster = true
          azure-vm    = false
          EOF

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan Destroy
        id: plan
        run: terraform plan -destroy -no-color -input=false
        continue-on-error: true

      - name: Terraform Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1

      - name: Terraform Destroy
        run: terraform destroy -auto-approve -input=false
