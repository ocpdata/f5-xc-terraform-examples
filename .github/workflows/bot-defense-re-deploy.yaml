name: "F5 XC Bot Defense on RE Deploy"

on:
  workflow_dispatch:

jobs:
  azure_infra:
    name: "Deploy Azure Infra (Networking)"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./azure/azure-infra
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Setup Terraform Backend
        run: |
          cat > backend.tf << 'TFEOF'
          terraform {
            cloud {
              organization = "${{ secrets.TF_CLOUD_ORGANIZATION }}"
              workspaces {
                name = "infra"
              }
            }
          }
          TFEOF

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        env:
          TF_VAR_tf_cloud_organization: ${{ secrets.TF_CLOUD_ORGANIZATION }}
          TF_VAR_azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          TF_VAR_azure_subscription_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
          TF_VAR_azure_service_principal_appid: ${{ secrets.AZURE_CLIENT_ID }}
          TF_VAR_azure_service_principal_password: ${{ secrets.AZURE_CLIENT_SECRET }}
          TF_VAR_azure_region: ${{ vars.AZURE_REGION }}
          TF_VAR_project_prefix: ${{ vars.PROJECT_PREFIX }}
          TF_VAR_nap: "false"
          TF_VAR_nic: "false"
          TF_VAR_bigip: "false"
          TF_VAR_bigip-cis: "false"
          TF_VAR_aks-cluster: "false"
          TF_VAR_azure-vm: "true"
          TF_VAR_vm_public_ip: "true"
        run: terraform apply -auto-approve -input=false

  azure_vm:
    name: "Deploy Azure VM (Origin)"
    runs-on: ubuntu-latest
    needs: [azure_infra]
    defaults:
      run:
        working-directory: ./azure/azure-vm
    outputs:
      vm_ip: ${{ steps.get_ip.outputs.vm_ip }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_wrapper: false

      - name: Setup Terraform Backend
        run: |
          cat > backend.tf << 'TFEOF'
          terraform {
            cloud {
              organization = "${{ secrets.TF_CLOUD_ORGANIZATION }}"
              workspaces {
                name = "${{ vars.TF_CLOUD_WORKSPACE_AZURE_VM }}"
              }
            }
          }
          TFEOF

      - name: Terraform Init
        run: terraform init

      - name: Accept Azure Marketplace terms for NGINX image
        run: |
          az login --service-principal \
            --username "${{ secrets.AZURE_CLIENT_ID }}" \
            --password "${{ secrets.AZURE_CLIENT_SECRET }}" \
            --tenant  "${{ secrets.AZURE_TENANT_ID }}"
          az account set --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          az vm image terms accept \
            --publisher nginxinc \
            --offer     nginx_plus_with_nginx_app_protect_premium \
            --plan      nginx_plus_with_nginx_app_protect_prem_ubuntu2004

      - name: Terraform Apply
        env:
          TF_VAR_tf_cloud_organization: ${{ secrets.TF_CLOUD_ORGANIZATION }}
          TF_VAR_azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          TF_VAR_azure_subscription_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
          TF_VAR_azure_service_principal_appid: ${{ secrets.AZURE_CLIENT_ID }}
          TF_VAR_azure_service_principal_password: ${{ secrets.AZURE_CLIENT_SECRET }}
          TF_VAR_vm_size: ${{ vars.AZURE_VM_SIZE }}
        run: terraform apply -auto-approve -input=false

      - name: Get VM IP
        id: get_ip
        run: |
          vm_ip=$(terraform output -raw vm_ip)
          echo "vm_ip=${vm_ip}" >> "$GITHUB_OUTPUT"
          echo "Azure VM IP: ${vm_ip}"

  terraform_xc_lb:
    name: "Deploy F5 XC Bot Defense"
    runs-on: ubuntu-latest
    needs: [azure_vm]
    defaults:
      run:
        working-directory: ./xc
    env:
      # ── XC Provider ──────────────────────────────────────────────────────────
      TF_VAR_api_url: ${{ secrets.XC_API_URL }}
      TF_VAR_xc_tenant: ${{ secrets.XC_TENANT }}
      TF_VAR_xc_namespace: ${{ vars.XC_NAMESPACE }}
      TF_VAR_app_domain: ${{ vars.APP_DOMAIN }}
      TF_VAR_tf_cloud_organization: ${{ secrets.TF_CLOUD_ORGANIZATION }}
      TF_VAR_ssh_key: ${{ secrets.SSH_PRIVATE_KEY }}
      # ── Bot Defense (fixed values for this workflow) ─────────────────────────
      TF_VAR_xc_bot_def: "true"
      TF_VAR_vk8s: "true" # Terraform coerces string "true" to bool
      TF_VAR_serviceName: ${{ needs.azure_vm.outputs.vm_ip }}
      TF_VAR_xc_app_type: "[]" # null causes length()/contains() to fail
      TF_VAR_xc_mud: "false"
      TF_VAR_xc_waf: "false"
      # ── Volterra Provider Auth ────────────────────────────────────────────────
      VES_P12_CONTENT: ${{ secrets.XC_API_P12_FILE }}
      VES_P12_PASSWORD: ${{ secrets.XC_P12_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Pull latest code
        run: |
          git config --global user.email @${{ github.actor }}
          git config --global user.name @${{ github.actor }}
          git remote add upstream https://github.com/f5devcentral/f5-xc-terraform-examples.git
          git fetch upstream
          git merge upstream/main --strategy-option theirs --allow-unrelated-histories

      - name: Create TF Cloud Workspace with Remote State Sharing
        id: create_workspace
        env:
          TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
        run: |
          ORG="${{ secrets.TF_CLOUD_ORGANIZATION }}"
          WS_NAME="${{ vars.TF_CLOUD_WORKSPACE_XC }}"
          API_BASE="https://app.terraform.io/api/v2"

          echo "Checking if workspace '${WS_NAME}' exists in org '${ORG}'..."
          HTTP_STATUS=$(curl -s -o /tmp/ws_get.json -w "%{http_code}" \
            --header "Authorization: Bearer ${TF_API_TOKEN}" \
            --header "Content-Type: application/vnd.api+json" \
            "${API_BASE}/organizations/${ORG}/workspaces/${WS_NAME}")

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "Workspace already exists. Ensuring local execution mode and remote state sharing..."
            WS_ID=$(jq -r '.data.id' /tmp/ws_get.json)
            curl -s \
              --header "Authorization: Bearer ${TF_API_TOKEN}" \
              --header "Content-Type: application/vnd.api+json" \
              --request PATCH \
              --data '{"data":{"type":"workspaces","attributes":{"execution-mode":"local","global-remote-state":true}}}' \
              "${API_BASE}/workspaces/${WS_ID}" > /dev/null
          else
            echo "Creating workspace '${WS_NAME}'..."
            curl -s \
              --header "Authorization: Bearer ${TF_API_TOKEN}" \
              --header "Content-Type: application/vnd.api+json" \
              --request POST \
              --data "{
                \"data\": {
                  \"attributes\": {
                    \"name\": \"${WS_NAME}\",
                    \"auto-apply\": false,
                    \"execution-mode\": \"local\",
                    \"global-remote-state\": true
                  },
                  \"type\": \"workspaces\"
                }
              }" \
              "${API_BASE}/organizations/${ORG}/workspaces" | tee /tmp/ws_create.json
            WS_ID=$(jq -r '.data.id' /tmp/ws_create.json)
            echo "Workspace created: ${WS_ID}"
          fi
          echo "workspace_id=${WS_ID}" >> "$GITHUB_OUTPUT"

      - name: Setup Terraform Backend
        id: backend
        run: |
          cat > backend.tf << 'TFEOF'
          terraform {
            cloud {
              organization = "${{ secrets.TF_CLOUD_ORGANIZATION }}"
              workspaces {
                name = "${{ vars.TF_CLOUD_WORKSPACE_XC }}"
              }
            }
          }
          TFEOF
          echo "${{ secrets.XC_API_P12_FILE }}" | base64 -d > api.p12

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Copy App Manifest
        run: cp ../shared/airline-app/airflask.yaml .

      - name: Check terraform version
        run: |
          terraform --version
          echo "event name is:" ${{ github.event_name }}

      - name: Terraform Apply
        run: terraform apply -auto-approve -input=false

      - name: Run Traffic
        run: |
          cp ../tools/run-curl-traffic.sh .
          export cname=$(terraform output -raw lb_cname)
          echo $cname
          sleep 30
          sh run-curl-traffic.sh "$cname/user/signin"
