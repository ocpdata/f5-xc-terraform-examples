name: "F5 XC Bot Defense on RE Deploy"

on:
  workflow_dispatch:
    inputs:
      origin_server:
        description: "Backend origin hostname or IP (e.g. 10.0.0.5 or app.example.com)"
        required: true
        type: string

jobs:
  terraform_xc_lb:
    name: "Deploy F5 XC Bot Defense"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./xc
    env:
      # ── XC Provider ──────────────────────────────────────────────────────────
      TF_VAR_api_url: ${{ secrets.XC_API_URL }}
      TF_VAR_xc_tenant: ${{ secrets.XC_TENANT }}
      TF_VAR_xc_namespace: ${{ vars.XC_NAMESPACE }}
      TF_VAR_app_domain: ${{ vars.APP_DOMAIN }}
      TF_VAR_tf_cloud_organization: ${{ secrets.TF_CLOUD_ORGANIZATION }}
      TF_VAR_ssh_key: ${{ secrets.SSH_PRIVATE_KEY }}
      # ── Bot Defense (fixed values for this workflow) ─────────────────────────
      TF_VAR_xc_bot_def: "true"
      TF_VAR_vk8s: "true" # Terraform coerces string "true" to bool
      TF_VAR_serviceName: ${{ github.event.inputs.origin_server }}
      TF_VAR_xc_app_type: "[]" # null causes length()/contains() to fail
      TF_VAR_xc_mud: "false"
      TF_VAR_xc_waf: "false"
      # ── Volterra Provider Auth ────────────────────────────────────────────────
      VES_P12_CONTENT: ${{ secrets.XC_API_P12_FILE }}
      VES_P12_PASSWORD: ${{ secrets.XC_P12_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Pull latest code
        run: |
          git config --global user.email @${{ github.actor }}
          git config --global user.name @${{ github.actor }}
          git remote add upstream https://github.com/f5devcentral/f5-xc-terraform-examples.git
          git fetch upstream
          git merge upstream/main --strategy-option theirs --allow-unrelated-histories

      - name: Create TF Cloud Workspace with Remote State Sharing
        id: create_workspace
        env:
          TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
        run: |
          ORG="${{ secrets.TF_CLOUD_ORGANIZATION }}"
          WS_NAME="${{ vars.TF_CLOUD_WORKSPACE_XC }}"
          API_BASE="https://app.terraform.io/api/v2"

          echo "Checking if workspace '${WS_NAME}' exists in org '${ORG}'..."
          HTTP_STATUS=$(curl -s -o /tmp/ws_get.json -w "%{http_code}" \
            --header "Authorization: Bearer ${TF_API_TOKEN}" \
            --header "Content-Type: application/vnd.api+json" \
            "${API_BASE}/organizations/${ORG}/workspaces/${WS_NAME}")

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "Workspace already exists. Ensuring local execution mode and remote state sharing..."
            WS_ID=$(jq -r '.data.id' /tmp/ws_get.json)
            curl -s \
              --header "Authorization: Bearer ${TF_API_TOKEN}" \
              --header "Content-Type: application/vnd.api+json" \
              --request PATCH \
              --data '{"data":{"type":"workspaces","attributes":{"execution-mode":"local","global-remote-state":true}}}' \
              "${API_BASE}/workspaces/${WS_ID}" > /dev/null
          else
            echo "Creating workspace '${WS_NAME}'..."
            curl -s \
              --header "Authorization: Bearer ${TF_API_TOKEN}" \
              --header "Content-Type: application/vnd.api+json" \
              --request POST \
              --data "{
                \"data\": {
                  \"attributes\": {
                    \"name\": \"${WS_NAME}\",
                    \"auto-apply\": false,
                    \"execution-mode\": \"local\",
                    \"global-remote-state\": true
                  },
                  \"type\": \"workspaces\"
                }
              }" \
              "${API_BASE}/organizations/${ORG}/workspaces" | tee /tmp/ws_create.json
            WS_ID=$(jq -r '.data.id' /tmp/ws_create.json)
            echo "Workspace created: ${WS_ID}"
          fi
          echo "workspace_id=${WS_ID}" >> "$GITHUB_OUTPUT"

      - name: Setup Terraform Backend
        id: backend
        run: |
          cat > backend.tf << 'TFEOF'
          terraform {
            cloud {
              organization = "${{ secrets.TF_CLOUD_ORGANIZATION }}"
              workspaces {
                name = "${{ vars.TF_CLOUD_WORKSPACE_XC }}"
              }
            }
          }
          TFEOF
          echo "${{ secrets.XC_API_P12_FILE }}" | base64 -d > api.p12

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Validate required variables
        run: |
          if [ -z "$TF_VAR_serviceName" ]; then
            echo "ERROR: origin_server input is empty."
            exit 1
          fi
          echo "ORIGIN_SERVER = $TF_VAR_serviceName"

      - name: Copy App Manifest
        run: cp ../shared/airline-app/airflask.yaml .

      - name: Check terraform version
        run: |
          terraform --version
          echo "event name is:" ${{ github.event_name }}

      - name: Terraform Apply
        run: terraform apply -auto-approve -input=false

      - name: Run Traffic
        run: |
          cp ../tools/run-curl-traffic.sh .
          export cname=$(terraform output -raw lb_cname)
          echo $cname
          sleep 30
          sh run-curl-traffic.sh "$cname/user/signin"
